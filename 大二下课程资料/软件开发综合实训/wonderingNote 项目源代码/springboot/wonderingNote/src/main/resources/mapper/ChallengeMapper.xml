<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.mapper.ChallengeMapper">
  <resultMap id="BaseResultMap" type="org.example.model.entity.Challenge">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="title" jdbcType="VARCHAR" property="title" />
    <result column="description" jdbcType="VARCHAR" property="description" />
    <result column="creator_id" jdbcType="BIGINT" property="creatorId" />
    <result column="object_type" jdbcType="VARCHAR" property="objectType" />
    <result column="gesture_type" jdbcType="VARCHAR" property="gestureType" />
    <result column="landmark_name" jdbcType="VARCHAR" property="landmarkName" />
    <result column="radius" jdbcType="DOUBLE" property="radius" />
    <result column="start_time" jdbcType="TIMESTAMP" property="startTime" />
    <result column="end_time" jdbcType="TIMESTAMP" property="endTime" />
    <result column="participants" jdbcType="VARCHAR" property="participants" />
    <result column="team_id" jdbcType="BIGINT" property="teamId" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="images" jdbcType="VARCHAR" property="images" />
    <result column="need_face_verify" jdbcType="TINYINT" property="needFaceVerify" />
  </resultMap>
  <resultMap extends="BaseResultMap" id="ResultMapWithBLOBs" type="org.example.model.entity.Challenge">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <result column="location" jdbcType="BINARY" property="location" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, title, description, creator_id, object_type, gesture_type, landmark_name, radius,
    start_time, end_time, participants, team_id, create_time, images, need_face_verify
  </sql>
  <sql id="Blob_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    location
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="ResultMapWithBLOBs">
    select
    <include refid="Base_Column_List" />,
    <include refid="Blob_Column_List" />,
    ST_AsText(location) as location  <!-- 确保这是最后一个字段 -->
    from challenge
    where id = #{id,jdbcType=BIGINT}
  </select>

  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from challenge
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="org.example.model.entity.Challenge" useGeneratedKeys="true" keyProperty="id">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      修改
      了
      自增
      功能
    -->
    insert into challenge (title, description,
    creator_id, object_type, gesture_type,
    landmark_name, radius, start_time,
    end_time, participants, team_id,
    create_time, images, need_face_verify,location
    )
    values (#{title,jdbcType=VARCHAR}, #{description,jdbcType=VARCHAR},
    #{creatorId,jdbcType=BIGINT}, #{objectType,jdbcType=VARCHAR}, #{gestureType,jdbcType=VARCHAR},
    #{landmarkName,jdbcType=VARCHAR}, #{radius,jdbcType=DOUBLE}, #{startTime,jdbcType=TIMESTAMP},
    #{endTime,jdbcType=TIMESTAMP}, #{participants,jdbcType=VARCHAR}, #{teamId,jdbcType=BIGINT},
    #{createTime,jdbcType=TIMESTAMP}, #{images,jdbcType=VARCHAR}, #{needFaceVerify,jdbcType=TINYINT},
    ST_GeomFromWKB(#{location}, 4326)
    )
  </insert>
  <insert id="insertSelective" parameterType="org.example.model.entity.Challenge">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into challenge
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="title != null">
        title,
      </if>
      <if test="description != null">
        description,
      </if>
      <if test="creatorId != null">
        creator_id,
      </if>
      <if test="objectType != null">
        object_type,
      </if>
      <if test="gestureType != null">
        gesture_type,
      </if>
      <if test="landmarkName != null">
        landmark_name,
      </if>
      <if test="radius != null">
        radius,
      </if>
      <if test="startTime != null">
        start_time,
      </if>
      <if test="endTime != null">
        end_time,
      </if>
      <if test="participants != null">
        participants,
      </if>
      <if test="teamId != null">
        team_id,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="images != null">
        images,
      </if>
      <if test="needFaceVerify != null">
        need_face_verify,
      </if>
      <if test="location != null">
        location,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=BIGINT},
      </if>
      <if test="title != null">
        #{title,jdbcType=VARCHAR},
      </if>
      <if test="description != null">
        #{description,jdbcType=VARCHAR},
      </if>
      <if test="creatorId != null">
        #{creatorId,jdbcType=BIGINT},
      </if>
      <if test="objectType != null">
        #{objectType,jdbcType=VARCHAR},
      </if>
      <if test="gestureType != null">
        #{gestureType,jdbcType=VARCHAR},
      </if>
      <if test="landmarkName != null">
        #{landmarkName,jdbcType=VARCHAR},
      </if>
      <if test="radius != null">
        #{radius,jdbcType=DOUBLE},
      </if>
      <if test="startTime != null">
        #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null">
        #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="participants != null">
        #{participants,jdbcType=VARCHAR},
      </if>
      <if test="teamId != null">
        #{teamId,jdbcType=BIGINT},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="images != null">
        #{images,jdbcType=VARCHAR},
      </if>
      <if test="needFaceVerify != null">
        #{needFaceVerify,jdbcType=TINYINT},
      </if>
      <if test="location != null">
        #{location,jdbcType=BINARY},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="org.example.model.entity.Challenge">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update challenge
    <set>
      <if test="title != null">
        title = #{title,jdbcType=VARCHAR},
      </if>
      <if test="description != null">
        description = #{description,jdbcType=VARCHAR},
      </if>
      <if test="creatorId != null">
        creator_id = #{creatorId,jdbcType=BIGINT},
      </if>
      <if test="objectType != null">
        object_type = #{objectType,jdbcType=VARCHAR},
      </if>
      <if test="gestureType != null">
        gesture_type = #{gestureType,jdbcType=VARCHAR},
      </if>
      <if test="landmarkName != null">
        landmark_name = #{landmarkName,jdbcType=VARCHAR},
      </if>
      <if test="radius != null">
        radius = #{radius,jdbcType=DOUBLE},
      </if>
      <if test="startTime != null">
        start_time = #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null">
        end_time = #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="participants != null">
        participants = #{participants,jdbcType=VARCHAR},
      </if>
      <if test="teamId != null">
        team_id = #{teamId,jdbcType=BIGINT},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="images != null">
        images = #{images,jdbcType=VARCHAR},
      </if>
      <if test="needFaceVerify != null">
        need_face_verify = #{needFaceVerify,jdbcType=TINYINT},
      </if>
      <if test="location != null">
        location = #{location,jdbcType=BINARY},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKeyWithBLOBs" parameterType="org.example.model.entity.Challenge">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update challenge
    set title = #{title,jdbcType=VARCHAR},
    description = #{description,jdbcType=VARCHAR},
    creator_id = #{creatorId,jdbcType=BIGINT},
    object_type = #{objectType,jdbcType=VARCHAR},
    gesture_type = #{gestureType,jdbcType=VARCHAR},
    landmark_name = #{landmarkName,jdbcType=VARCHAR},
    radius = #{radius,jdbcType=DOUBLE},
    start_time = #{startTime,jdbcType=TIMESTAMP},
    end_time = #{endTime,jdbcType=TIMESTAMP},
    participants = #{participants,jdbcType=VARCHAR},
    team_id = #{teamId,jdbcType=BIGINT},
    create_time = #{createTime,jdbcType=TIMESTAMP},
    images = #{images,jdbcType=VARCHAR},
    need_face_verify = #{needFaceVerify,jdbcType=TINYINT},
    location = #{location,jdbcType=BINARY}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="org.example.model.entity.Challenge">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update challenge
    set title = #{title,jdbcType=VARCHAR},
    description = #{description,jdbcType=VARCHAR},
    creator_id = #{creatorId,jdbcType=BIGINT},
    object_type = #{objectType,jdbcType=VARCHAR},
    gesture_type = #{gestureType,jdbcType=VARCHAR},
    landmark_name = #{landmarkName,jdbcType=VARCHAR},
    radius = #{radius,jdbcType=DOUBLE},
    start_time = #{startTime,jdbcType=TIMESTAMP},
    end_time = #{endTime,jdbcType=TIMESTAMP},
    participants = #{participants,jdbcType=VARCHAR},
    team_id = #{teamId,jdbcType=BIGINT},
    create_time = #{createTime,jdbcType=TIMESTAMP},
    images = #{images,jdbcType=VARCHAR},
    need_face_verify = #{needFaceVerify,jdbcType=TINYINT}
    where id = #{id,jdbcType=BIGINT}
  </update>

  <select id="selectById" resultMap="BaseResultMap">
    SELECT
      id, title, description, creator_id, object_type, gesture_type, landmark_name, radius,
      start_time, end_time, participants, team_id, create_time, images,need_face_verify,
      ST_AsText(location) as location
    FROM challenge
    WHERE id = #{id}
  </select>

  <select id="selectByIds" resultMap="BaseResultMap">
    SELECT
    id, title, description, creator_id, object_type, gesture_type,
    landmark_name, radius, start_time, end_time, participants,
    team_id, create_time, images,
    ST_AsText(location) as location  <!-- 添加这一行 -->
    FROM challenge
    WHERE id IN
    <foreach close=")" collection="ids" item="id" open="(" separator=",">
      #{id}
    </foreach>
    ORDER BY id DESC
  </select>

  <select id="selectByTeamId" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!-- 根据 teamId 查找记录 -->
    SELECT
    id, title, description, creator_id, object_type, gesture_type, landmark_name, radius,
    start_time, end_time, participants, team_id, create_time, images,
    ST_AsText(location) as location
    FROM challenge
    WHERE team_id = #{teamId}
  </select>

  <!--  TOTORO编辑，获取挑战根据用户id,这里需要转一下Location,而且不包含团队信息-->
  <select id="selectChallengesByCreator" parameterType="map" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List" />,
    ST_AsText(location) as location
    FROM challenge
    WHERE creator_id = #{params.creatorId}
    AND team_id IS NULL
    <if test="params.lastCursor != null and params.lastCursor != 0">
      AND id &lt;= #{params.lastCursor}  <!-- 改为 &lt; 更符合分页逻辑 -->
    </if>
    ORDER BY id DESC
    LIMIT #{params.size}
  </select>
  <!---->

  <select id="selectChallengeTotal" resultType="int">
    SELECT COUNT(*) FROM challenge
  </select>

  <select id="selectChallengeAddToday" resultType="int">
    SELECT COUNT(*) FROM challenge WHERE DATE(create_time) = CURDATE()
  </select>

  <!--  TOTORO-->
  <!-- 新增查询：查询未结束的挑战列表 -->
  <select id="selectUnfinishedChallenges" parameterType="map" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List" />,
    <include refid="Blob_Column_List" />,
    ST_AsText(location) as location
    FROM challenge
    WHERE team_id IS NULL
    <if test="params.lastCursor != null and params.lastCursor != 0">
      AND id &lt;= #{params.lastCursor}
    </if>
    ORDER BY id DESC
    <if test="params.size != null and params.size > 0">
      LIMIT #{params.size}
    </if>
  </select>

  <!--  -->
  <select id="selectByTitleAndCreateTimeRange" parameterType="map" resultMap="BaseResultMap">
    SELECT
    id, title, description, creator_id, object_type, gesture_type, landmark_name, radius,
    start_time, end_time, participants, team_id, create_time, images,
    ST_AsText(location) as location
    FROM challenge
    WHERE 1=1
    <if test="title != null and title != ''">
      AND title LIKE CONCAT('%', #{title}, '%') <!-- 模糊搜索 title -->
    </if>
    <if test="startTime != null">
      AND create_time >= #{startTime} <!-- 起始时间范围 -->
    </if>
    <if test="endTime != null">
      AND create_time &lt;= #{endTime} <!-- 结束时间范围 -->
    </if>
    ORDER BY create_time DESC <!-- 按创建时间降序排列 -->
  </select>

  <select id="selectByTitleAndCreateTimeRange_1" parameterType="map" resultMap="BaseResultMap">
    SELECT
    id, title, description, creator_id, object_type, gesture_type, landmark_name, radius,
    start_time, end_time, participants, team_id, create_time, images,
    ST_AsText(location) as location
    FROM challenge
    WHERE team_id IS NULL
    <if test="params.title != null and params.title != ''">
      AND title LIKE CONCAT('%', #{params.title}, '%') <!-- 模糊搜索 title -->
    </if>
    <if test="params.startTime != null and params.endTime != null">
      AND create_time BETWEEN #{params.startTime} AND #{params.endTime}
    </if>
    <if test="params.lastCursor != null and params.lastCursor != 0">
      AND id &lt;= #{params.lastCursor}
    </if>
    ORDER BY id DESC
    <if test="params.size != null and params.size > 0">
      LIMIT #{params.size}
    </if>
  </select>


  <!-- 由TOTORO编写 -->
  <select id="selectUserChallengeCount" parameterType="java.lang.Long" resultType="java.lang.Integer">
    SELECT COUNT(*) FROM challenge WHERE creator_id = #{creatorId}
  </select>

  <!--  TOTORO编辑，获取挑战根据用户id,这里需要转一下Location,而且不包含团队信息-->
  <select id="selectChallengesById" parameterType="map" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List" />,
    ST_AsText(location) as location
    FROM challenge
    WHERE creator_id = #{params.userId}
    <if test="params.lastCursor != null and params.lastCursor != 0">
      AND id &lt;= #{params.lastCursor}  <!-- 改为 &lt; 更符合分页逻辑 -->
    </if>
    ORDER BY id DESC
    LIMIT #{params.size}
  </select>
  <!---->


  <select id="selectByTitleAndCreateTimeRange_2" parameterType="map" resultMap="BaseResultMap">
    SELECT
    id, title, description, creator_id, object_type, gesture_type, landmark_name, radius,
    start_time, end_time, participants, team_id, create_time, images,
    ST_AsText(location) as location
    FROM challenge
    WHERE creator_id = #{params.userId}
    <if test="params.title != null and params.title != ''">
      AND title LIKE CONCAT('%', #{params.title}, '%') <!-- 模糊搜索 title -->
    </if>
    <if test="params.startTime != null and params.endTime != null">
      AND create_time BETWEEN #{params.startTime} AND #{params.endTime}
    </if>
    <if test="params.lastCursor != null and params.lastCursor != 0">
      AND id &lt;= #{params.lastCursor}
    </if>
    ORDER BY id DESC
    <if test="params.size != null and params.size > 0">
      LIMIT #{params.size}
    </if>
  </select>


  <select id="selectByTeamId_1" parameterType="map" resultMap="BaseResultMap">
    <!-- 根据 teamId 查找记录 -->
    SELECT
    id, title, description, creator_id, object_type, gesture_type, landmark_name, radius,
    start_time, end_time, participants, team_id, create_time, images,
    ST_AsText(location) as location
    FROM challenge
    WHERE team_id = #{params.teamId}
    <if test="params.lastCursor != null and params.lastCursor != 0">
      AND id >= #{params.lastCursor}
    </if>
    ORDER BY id ASC
    <if test="params.size != null and params.size > 0">
      LIMIT #{params.size}
    </if>
  </select>
</mapper>