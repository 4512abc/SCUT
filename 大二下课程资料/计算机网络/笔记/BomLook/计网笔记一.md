# 计网笔记一

一个计算机网络通过连接**网络设备和数据链路**，**将地理位置分散的计算机连接在一起，实现网络资源的共享和消息传输**。（基于已经建立的网络协议和应用程序）

网络协议定义了**网络设备之间通信的规则和约定**。也就是说，它是设备之间使用的语言。

网络协议包括**设备识别和相互连接的机制**，以及**规定数据如何打包成发送和接收消息的格式规则**。

协议必须以某种方式在某个地方实现。

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506022038073.webp)

在发送节点，对信息进行封装，在接受节点，对信息进行解封装。

一些重要概念：

1. (Computer) Network and Graph (G={N, E})
2. Device/Node
3. (Communication) Link and up/downlink
4. End device/Host/Networking device
5. Desktop, Laptop, smart phone, printer and …
6. Router and Switch
7. Wired/Wireless link and physical media
8. Network Edge/Core and Access network
9. Point of presence and Network Provider
10. Home/Residential/Enterprise network
11. Local Area Network and Wide Area Network
12. Subnet and Gateway
13. Cellular network and Internet of Things
14. Application
15. Web browser and Web Server
16. Network protocol
17. HTTP
18. Message transmission
19. Markup Language and HTML
20. Service model
21. Socket Interface
22. Message and Packet
23. Encapsulation and Decapsulation
24. Packet switching and Circuit switching
25. Multiplexing and Sharing of network core


接入网分类：

- 按照位置划分：家庭网络、企业网络、移动网络

技术上：

- DSL、有线电视、FTTH、拨号上网和卫星
- 以太网和 WiFi
- 3G、LTE（4G）和 5G



网络设备

- 所有这些被称为网络设备，但它们扮演着截然不同的角色。
- 有些设备位于网络边缘，被终端用户使用，包括：
  - 计算机（台式机、笔记本电脑、平板电脑、手机等），被称为终端系统或主机。
  - 网络设备、中继器、集线器、交换机、路由器、现代设备等。networking devices, repeaters, hubs, switches, routers, moderns, etc
- 其他设备位于网络核心，由网络服务提供商管理。
  - 主要是高性能路由器
  - 文件服务器、邮件服务器、DNS 服务器等……



数据链路或者物理介质链接：

- 所有提到的设备都需要通过数据链路或物理介质连接，这些介质可以是：
  - 有线，例如：**双绞线铜缆、同轴电缆、光纤电缆，………**…
  - 或者无线，即**电磁频谱**
- 网络接口卡（NIC）或控制器是一种硬件组件，用于将网络设备连接到计算机网络。
  - 传统的 NIC 通常通过插入计算机总线上的扩展卡来实现。
  - 现在，大多数是主板集成的。



网络协议：

不是只有一个协议来实现消息传输，而是在每一层都有一套协议！HTTP，TCP，IP，ARP，DNS，…………

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506022122105.webp)





Information, Data, Messages and Packet 信息，数据，消息和分组

- 在计算机世界中，**信息或数据作为消息的内容传递；是一种高度抽象的形式或临时形式。**
- 信息可以被编码成各种形式进行传输和解释。
- 消息是**源头发送，供一个或一组接收者消费**的离散通信单元。
- 消息可以通过多种方式传递，包括信鸽、计算机网络等。
- **数据在发送和接收时被封装成消息。即所谓的数据包**



消息传输与资源共享

- 主要目的：
  - 消息传输：将消息从一个计算机传输到另一个计算机；这是最基本的一项！
  - 资源共享：使用连接到网络上的资源（例如打印机）。
- 客户端和服务器（C/S）计算或通信模型



电路交换：保证速率传输（一个真实的连接必须被保留）

- 在消息传输之前必须建立端到端的连接。
- 为提供通信所需沿路径的资源（缓冲区、链路传输速率）在通信会话期间被保留。
- 这种连接被称为 circuit
- 链路中的电路可以通过以下方式实现：频分复用 (FDM)，时分复用 (TDM)
- 信息来源很重要！！关系着电路交换的合理性：
  - 编码、传输、缓冲和解码是语音通信中的四个必要步骤。
  - 编码速率 S：b/s 或 bps（每秒比特数）
    - S = R * F，其中 F 是采样频率，R 是每个采样值的比特数。
    - 例如，R = 8 位，F = 8KHz，那么 S = 64Kbps！
  - 类比电话系统，如果语音以 64Kbps 进行编码，就必须以这个恒定速率发送！
  - 因此，保证速率传输是旧式电话系统中语音通信的固有要求。这就使得电路交换（为预留带宽建立连接）变得合理！
  - ![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506022157058.webp)
- 计算机**以突发方式发送数据**
  - 计算机**经常缓存数据**，然后希望在非常短的时间内发送大量数据！
  - 因此，作为信息源，计算机以突发方式使用网络。**大部分时间不传输任何数据**，但**发送时需要非常高的传输速率**（如果可能）!!

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506022141913.webp)

分组交换

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506022157665.webp)

- 将数据打包成**数据块，并以尽可能高的速率发送出去**
- 数据被分割成称为数据包的数据块，并随意发送（无连接~）。
- 在从源到目的地的路径上，这些数据包会**通过通信链路和包交换机传输**
- 数据包在**每条通信链路上以链路完全传输的速率进行传输**!!
- 存储转发：每个数据包必须在每个数据包交换机处**完全接收并缓冲，检查其目的地，然后从交换机的另一条链路发送出去**。

> 在网络中，存储转发（Store-and-Forward）机制的工作流程如下：
>
> 1. **完整接收数据包**：交换机必须接收到整个数据包（包括所有数据块）并缓存到内存中后，才会进行下一步处理。
> 2. **校验与解析**：在缓存完成后，交换机会检查数据包的完整性（如校验和），解析帧头信息（如目的MAC地址）。
> 3. **确定转发端口**：根据解析到的目的地址和交换机的转发表（如MAC地址表），确定输出端口。
> 4. **转发数据包**：最后将完整的数据包从确定的端口转发出去。
>
> ### 关键点：
> - **必须缓存完整数据包**：存储转发要求交换机在转发前接收并存储整个数据包，这是其与直通转发（Cut-Through）的主要区别。
> - **转发决策时机**：只有在完整接收并解析数据包后，才能做出转发决策（如确定输出端口）。如果数据包被分割为多个数据块（如分片IP包），交换机需等待所有分片到达并重组后才会处理。
>
> ### 其他转发模式的对比：
> - **直通转发（Cut-Through）**：交换机在收到帧头后立即开始转发（无需等待完整数据包），但可能转发错误或无效帧。
> - **无碎片转发（Fragment-Free）**：仅接收前64字节（避免转发冲突碎片），是直通转发的优化版本。
>
> ### 总结：
> 在存储转发模式下，**交换机必须缓存完整数据包后才能确定转发端口**。这是其可靠性的代价（延迟较高但能过滤错误帧）。如果数据包被分割，需等待所有数据块到达并重组完毕才会进入转发流程。





计算机网络的核心设备

- 包交换机是多链路设备，每个链路都包含**输入和输出缓冲区！**
- **如果链路正被另一个包使用，数据包可能会排队在链路的输出缓冲区！**
- 交换机中的**存储转发（排队和处理）引入了：延迟和数据包丢失**
- 主要有两种类型：路由器和链路层交换机。



分组交换网络中的统计复用（排队让一切变得不可预测）

- 数据包在路径上使用共享通信链路按需以全速率传输，当其他数据包占用链路时，它会在分组交换时排队！
- **按需共享资源被称为统计复用！**
- 存储转发在每个交换机中引入！排队导致延迟发生了变化



可靠性考虑

- 事实：网络基础设施有点不可靠？
  - 比特错误
  - 数据包丢失（在网络核心和终端系统）
  - 重复数据包
  - 无序到达
- 也就是说，**仅提供尽力而为的服务**



问题：我们如何才能实现可靠的端到端数据传输？记住，**网络核心（路由器）不受终端用户（系统）控制！**

- **必须在两个端系统上采用机制，而无需核心的帮助！**



端到端连接

- 如果需要**可靠传输，必须在发送第一个数据包之前建立连接**。
  - 至少要确认**接收节点在线且准备就绪！**
  - 这被称为**面向连接的传输 (Connection-Oriented Transport)**
- 这种连接**仅在两端共享传输参数，但并不保留任何网络资源**；当然，它与电路交换中的连接非常不同。**网络核心对这种连接一无所知！**
- 需要采用几种机制来处理网络错误。



实现**可靠传输**

- 对于**比特错误：错误检测码和错误纠正码**。Error detection/correction code
  - 比特异或案例 ~~ (011 -- 111 ?)；互联网校验和
- 对于**数据包丢失：超时和重传**
- 对于**无序到达和重复**的分组：每个分组中的**序列号属于一个消息，用于识别。**
- 对于**不匹配的速度：通过接收者向发送者报告可用缓冲区大小来控制发送者的发送速率；这就是所谓的流量控制（流量控制）。**
- 如果**没有人关心其他人，网络可能会拥塞**！所以，要友善；以较低的速率开始发送，探测网络，如果良好，则增加发送速率！这被称为**拥塞控制（拥塞控制）。**
- 假设**数据包已经成功到达接收者，发送者如何知道这个事实呢**？
  - **接收者应该向发送者发送确认（ACK）**！！希望这是正常且最常见的情况！
- 所有这些工作都只需在通信两端维护和检查一组连接参数即可完成。



寻址问题

- 事实上，我们面对的是一套寻址或识别问题。我们处理消息传输问题是在分层架构中，部分问题在每个层中解决。
- 寻址问题出现在多个层。
  - **识别应用**
  - **网络层中的主机寻址**
  - **数据链路层中的主机寻址**

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031539895.webp)

应用程序识别

- 事实：在通信的端系统对中运行着**多个应用程序**；消息传输实际上是**应用程序 A 向 B 中的相应应用程序发送消息**。
  - 问题：当数据包成功接收时，如何识别目标应用程序？
  - 事实上，**需要识别的是套接字。一个应用程序可以分叉多个进程，任何进程都可能使用网络发送消息**。要发送消息，进程**使用底层操作系统提供的套接字接口/服务。端口号在两者中都使用，用于识别套接字。**

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031543594.webp)





主机的IP地址以及路由器（在全局网络环境下）

- **一台主机可能连接多个网卡；寻址是为每个网卡分配一个 IP 地址。**
- 在**全局网络中，每个网卡的 IP 地址必须是唯一**的！
- IP 地址：32 位（二进制格式下），例如 159.121.58.23

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031627051.webp)

- 更多关于 IP 地址，涉及两组：

  - 保留/私有 IP
  - 全球 IP

  ![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031630898.webp)



主机识别（在内部网络环境中）

有具有相同 IP 地址的计算机

- 一个通常连接到他或她所在组织构建的内部网络的设备。然后**通过网关路由器将内部网络连接到网络核心，以便与其他网络互连**。
- 一个（新的）连接到**内部网络的设备会被分配一个唯一的私有 IP 地址**（例如 192.168.0.12），而不是一个全球性的 IP 地址。因此，**可能有多个主机具有相同的 IP 地址，但它们必须位于自己的内部环境中，即从外部不可见**。
- 网关路由器采用了**网络地址转换（NAT）机制**！在两台计算机之间实现端到端连接取决于它们的内部网络

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031639505.webp)



为什么每个主机（再次，是网卡）需要两个地址？

- **链路层为连接到同一链路的设备提供通信服务**；也就是说共享链路。
  
  - 点对点链路：**每端链路只有两个设备**
  - 广播链路：**超过两个设备共享链路**
- IP 地址用于将**一个 IP 数据包从一个网络移动到另一个网络，直到它到达最终目的地**。
- 链路层地址用于**在链路内部移动一个链路层数据包**。
  - 一个链路层数据包可能不携带一个 IP 数据包;
  - 使用额外的地址层为网络提供了更灵活的架构。
  
  > 是的，一个链路层（如以太网）数据包（帧）**不一定**总是携带一个完整的IP数据包，原因如下：
  >
  > ---
  >
  > ### 1. **IP数据包分片（Fragmentation）**
  >    - **MTU不匹配**：当IP数据包长度超过链路层的**最大传输单元（MTU）**时，网络层（IP协议）会将其分片为多个小块。每个分片是一个独立的IP数据包，但会被封装到**不同的链路层帧**中传输。
  >      - **示例**：若IP包大小为4000字节，而以太网MTU为1500字节，则会被分成3个IP分片，分别封装到3个以太网帧中。
  >    - **分片标志**：IP头中的`Fragment Offset`和`More Fragments`字段用于指示分片关系，接收端需重组后才能还原原始IP包。
  >
  > ---
  >
  > ### 2. **链路层帧可能封装其他协议数据**
  >    - **非IP流量**：链路层帧的载荷（Payload）不一定承载IP数据包，可能是其他网络层协议的数据，例如：
  >      - **ARP协议**（地址解析协议）：以太网帧直接封装ARP请求/应答，无IP层介入。
  >      - **VLAN标签**：802.1Q帧携带VLAN信息，与IP无关。
  >      - **MPLS标签**：多协议标签交换直接基于标签转发，无需IP包头。
  >    - **隧道协议**：如PPPoE（宽带拨号）、GRE（通用路由封装）等，会在链路层和IP层之间插入额外协议头，导致一个链路层帧可能嵌套多层封装。
  >
  > ---
  >
  > ### 3. **填充（Padding）或帧最小长度限制**
  >    - **以太网最小帧长**：以太网帧要求至少64字节（含头和CRC）。若IP数据包过小（如ICMP Ping请求仅28字节），链路层会通过**填充（Padding）**补足，此时帧载荷大于实际IP包。
  >
  > ---
  >
  > ### 4. **链路层聚合或分块**
  >    - **链路层分片**：某些技术（如Wi-Fi的A-MPDU）会将多个小帧聚合为一个大数据块传输，但逻辑上仍是独立帧。
  >    - **巨型帧（Jumbo Frame）**：支持MTU超过1500字节的链路层帧可能携带多个IP包（需上层协议支持，实际罕见）。
  >
  > ---
  >
  > ### 关键总结
  > - **1个IP包 → 多个链路层帧**：因分片（Fragmentation）或MTU限制。
  > - **1个链路层帧 → 非IP数据**：如ARP、MPLS等协议直接占用载荷。
  > - **1个链路层帧 → 部分IP包**：因填充或未分片的短IP包。
  >
  > 这种解耦设计使得链路层（如以太网）能灵活适配不同网络层协议（IP、IPX等），而IP层也能适应多种底层链路（以太网、PPP、Wi-Fi等）。

> 每台主机通常有两个地址——**IP 地址（网络层）**和 **MAC 地址（数据链路层）**，这是因为计算机网络采用分层架构（如TCP/IP或OSI模型），不同层使用不同的寻址方式来完成端到端的通信。具体原因如下：
>
> ---
>
> ### 1. **IP 地址（网络层）**
>    - **作用**：用于**全局寻址**，标识主机所在的**逻辑网络位置**（如 `192.168.1.10`）。IP 地址是**分层的**（**通过子网划分**），方便路由器在**不同网络间进行分组转发**。
>    - **使用场景**：
>      - 源主机和目标主机通信时，需要**知道对方的IP地址**（例如访问网站时输入域名，DNS解析后得到IP）。
>      - **路由器根据IP地址决定如何将数据包跨网络转发**（基于路由表）。
>
> ---
>
> ### 2. **MAC 地址（数据链路层）**
>    - **作用**：用于**本地物理寻址**，标识同一链路（如以太网、Wi-Fi）上的设备（如 `00:1A:2B:3C:4D:5E`）。**MAC 地址是扁平化的，全球唯一，但无层次性。**
>    - **使用场景**：
>      - 交换机/AP（接入点）在**同一局域网内**通过MAC地址转发数据帧（二层交换）。
>      - 当数据包到达目标网络后，需要通过**ARP协议将IP地址映射为MAC地址**，才能最终交付给目标主机。
>
> ---
>
> ### 为什么需要两个地址？
> #### （1）分层解耦
>    - **IP 地址**解决的是**“如何跨网络找到目标主机”（网络层职责）**。
>    - **MAC 地址**解决的是“**如何在当前链路上找到下一跳设备”（数据链路层职责）。**
>    - 分层设计让网络设备各司其职：
>      - **路由器**处理IP地址（网络层），负责跨网络路由。
>      - **交换机**处理MAC地址（数据链路层），负责局域网内帧转发。
>
> #### （2）技术限制
>    - 交换机（二层设备）不解析IP包头部，仅根据MAC地址转发帧。
>    - IP 地址可动态分配（如DHCP），而MAC地址固化在网卡中，更适合物理寻址。
>
> ---
>
> ### 举例：主机A（IP1/MAC1）访问主机B（IP2/MAC2）
> 1. **网络层**：主机A检查目标IP2是否在同一子网。
>    - 若不在，将数据包发给**默认网关**（路由器的IP，对应MAC-R）。
> 2. **数据链路层**：
>    - 主机A通过ARP查询网关的MAC地址（MAC-R），封装帧（目标MAC=MAC-R）。
>    - 交换机根据MAC-R将帧转发给路由器。
> 3. **路由器**解封装帧，读取IP2，重新封装帧（目标MAC=MAC2），最终送达主机B。
>
> ---
>
> ### 关键点总结
> - **IP 地址**是逻辑地址，用于端到端通信（跨网络）。
> - **MAC 地址**是物理地址，用于点到点传输（同一链路）。
> - 两个地址通过**ARP协议**动态映射，协同工作。
>
> 这种设计既保证了网络的扩展性（IP地址分层），又兼容了底层链路的多样性（如以太网、Wi-Fi、光纤等依赖MAC地址）。





> ### **HDLC（高级数据链路控制，High-Level Data Link Control）**  
> **HDLC** 是一种**面向比特**（bit-oriented）的**数据链路层协议**，由国际标准化组织（ISO）在1979年标准化（ISO 13239），广泛用于**同步串行通信**（如专线、帧中继、PPP等）。  
>
> ---
>
> ## **1. HDLC 的核心特点**
> ### **(1) 面向比特的协议**
> - 数据以**比特流**（而非字符或字节）形式传输**，适用于任意二进制数据**（如IP包、语音、视频等）。
> - 对比：**面向字符**的协议（如PPP早期版本）需依赖特定字符（如ASCII）进行控制。
>
> ### **(2) 帧结构**
> HDLC帧由以下字段组成：
> | 字段               | 说明                                                       |
> | ------------------ | ---------------------------------------------------------- |
> | **Flag (1B)**      | 帧起始/结束标志（固定为`0x7E`，即二进制`01111110`）。      |
> | **Address (1B)**   | 标识接收方地址（在点对点链路中通常无意义，可设为`0xFF`）。 |
> | **Control (1B)**   | 控制帧类型（信息帧、监控帧、无编号帧）。                   |
> | **Payload (变长)** | 承载的数据（如IP包、PPP数据等）。                          |
> | **FCS (2/4B)**     | 帧校验序列（CRC校验，确保数据完整性）。                    |
> | **Flag (1B)**      | 帧结束标志（同起始标志`0x7E`）。                           |
>
> ### **(3) 透明传输（比特填充）**
> - **问题**：若载荷数据中出现`0x7E`（`01111110`），会被误认为帧结束。
> - **解决**：发送方在连续5个`1`后自动插入`0`（零比特填充），接收方删除填充的`0`。  
>   - 例如：原始数据 `01111110` → 填充后 `0111110**1**0`（插入的`0`加粗）。
>
> ### **(4) 工作模式**
> - **NRM（正常响应模式）**：主从架构，主站控制从站的发送权限（如早期的SDLC）。
> - **ARM（异步响应模式）**：从站可主动发送数据（需主站允许）。
> - **ABM（异步平衡模式）**（最常用）：通信双方平等（如PPP协议）。
>
> ---
>
> ## **2. HDLC 的应用场景**
> ### **(1) 专线（Leased Line）通信**
> - 运营商提供的点对点专线（如E1/T1）常使用HDLC封装IP数据包。
>
> ### **(2) PPP（点对点协议）的基础**
> - PPP协议基于HDLC改进，增加了认证（如PAP/CHAP）、多协议支持（如IP、IPX）等功能。
>
> ### **(3) 帧中继（Frame Relay）**
> - 帧中继的底层帧结构源自HDLC，但简化了错误控制（依赖上层协议纠错）。
>
> ### **(4) 其他衍生协议**
> - Cisco HDLC：思科私有扩展，支持多协议（需两端均为思科设备）。
> - LAPB（X.25）、LAPD（ISDN）等均基于HDLC设计。
>
> ---
>
> ## **3. HDLC vs. PPP**
> | 特性         | HDLC                   | PPP（基于HDLC改进）      |
> | ------------ | ---------------------- | ------------------------ |
> | **认证**     | 不支持                 | 支持（PAP/CHAP）         |
> | **多协议**   | 通常仅支持IP           | 支持IP、IPX、AppleTalk等 |
> | **错误检测** | 依赖FCS                | 同HDLC                   |
> | **适用场景** | 专线、设备厂商私有扩展 | 拨号、广域网（如ADSL）   |
>
> ---
>
> ## **4. 总结**
> - HDLC是**经典的同步数据链路层协议**，核心特点是**面向比特、透明传输、可靠帧结构**。
> - 虽然现代网络更多使用PPP或以太网，但HDLC仍广泛应用于专线、帧中继及设备厂商（如思科）的私有实现。
> - **关键记住**：`0x7E`标志、比特填充、三种工作模式（NRM/ARM/ABM）。

主机的 MAC 地址

- 网络接口卡的链路层地址称为 MAC 地址。
- MAC 地址在制造后分配给网络接口卡，旨在全球唯一。
- 48 位，例如：44-45-53-54-00-00
  - 当 A 想要向 B 发送一个 IP 数据包时，它会添加源 MAC 地址和目标 MAC 地址
  - A：`{S_MAC_A|D_MAC_R1|192.168.0.10|222.201.134.164|81|80|messgage|CRC}`
  - MAC_R1：是默认网关 192.168.0.254 的 MAC 地址
  - 一个用户使用 ARP 协议询问：谁拥有 192.168.0.254，告诉我你的 MAC 地址？

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031702462.webp)



![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031703896.webp)



如果发送一个 IP 数据包，其中的MAC地址是如何确定封装的

> 当发送一个 **IP数据包** 时，**MAC地址的封装** 是通过 **ARP（地址解析协议）** 或 **邻居发现协议（NDP，IPv6）** 动态确定的，具体过程如下：
>
> ---
>
> ## **1. 确定目标MAC地址的流程**
> ### **(1) 检查目标IP是否在同一局域网（子网）**
> - **如果目标IP在同一子网**（如 `192.168.1.100` → `192.168.1.200`）：
>   - 直接使用 **ARP**（IPv4）或 **NDP**（IPv6）查询目标IP对应的MAC地址。
> - **如果目标IP在不同子网**（如 `192.168.1.100` → `8.8.8.8`）：
>   - 数据包先发送到 **默认网关（路由器）**，因此需要获取 **网关的MAC地址**（而不是目标IP的MAC）。
>
> ### **(2) 查询ARP缓存（IPv4）**
> - 发送方先检查本地 **ARP缓存表**，看是否已缓存目标IP对应的MAC地址：
>   ```bash
>   # Windows 查看ARP缓存
>   arp -a
>   
>   # Linux/Mac 查看ARP缓存
>   ip neigh  # 或 `arp -n`
>   ```
> - **如果缓存命中**：直接使用缓存的MAC地址封装数据帧。
> - **如果缓存未命中**：触发 **ARP请求**（广播）获取目标MAC。
>
> ### **(3) ARP请求（IPv4）**
> - **广播查询**：发送方发送 **ARP请求包**（`Who has 192.168.1.200? Tell 192.168.1.100`）到 `FF:FF:FF:FF:FF:FF`（广播地址）。
> - **单播响应**：目标设备（`192.168.1.200`）回复自己的MAC地址。
> - **更新ARP缓存**：发送方记录 `IP → MAC` 映射，后续通信无需重复查询。
>
> ### **(4) 封装以太网帧**
> - **源MAC**：发送方网卡地址（如 `AA:BB:CC:11:22:33`）。
> - **目标MAC**：
>   - 同一子网 → 目标设备的MAC（如 `DD:EE:FF:44:55:66`）。
>   - 不同子网 → 网关的MAC（如 `11:22:33:44:55:66`）。
>
> **示例帧结构**：
> ```
> | 目标MAC       | 源MAC         | 类型（0x0800=IPv4） | IP数据包       | FCS（校验） |
> |---------------|---------------|---------------------|----------------|------------|
> | DD:EE:FF:44:55:66 | AA:BB:CC:11:22:33 | 0x0800            | (IP Header + Data) | CRC32      |
> ```
>
> ---
>
> ## **2. IPv6 的MAC地址获取（NDP）**
> IPv6 使用 **邻居发现协议（NDP）** 替代ARP，机制类似：
> 1. 发送 **邻居请求（Neighbor Solicitation，NS）**（相当于ARP请求）。
> 2. 目标设备回复 **邻居通告（Neighbor Advertisement，NA）**（相当于ARP响应）。
> 3. 使用 **ICMPv6** 而非广播（更高效）。
>
> ---
>
> ## **3. 跨子网通信的特殊情况**
> **如果目标IP不在同一子网**（如家庭设备访问Google）：
>
> 1. **目标MAC = 网关MAC**（由DHCP或手动配置的默认网关）。
> 2. 网关路由器收到后，再根据路由表决定下一跳（可能再次ARP查询）。
>
> **示例**：
> ```
> 设备（192.168.1.100） → 目标（8.8.8.8）
> 1. 检查 8.8.8.8 不在 192.168.1.0/24 子网。
> 2. 目标MAC = 网关MAC（如 192.168.1.1 的MAC）。
> 3. 网关路由器解封装IP包，重新查询下一跳MAC（如ISP路由器）。
> ```
>
> ---
>
> ## **4. 关键总结**
> | 步骤           | IPv4（ARP）     | IPv6（NDP）      |
> | -------------- | --------------- | ---------------- |
> | **查询缓存**   | `arp -a`        | `ip -6 neigh`    |
> | **请求方式**   | 广播ARP请求     | 组播NS（ICMPv6） |
> | **响应方式**   | 单播ARP响应     | 单播NA（ICMPv6） |
> | **跨子网处理** | 目标MAC=网关MAC | 目标MAC=网关MAC  |
>
> ---
>
> ## **5. 常见问题**
> ### **Q1: 为什么需要MAC地址，不能只用IP？**
> - **数据链路层（如以太网）依赖MAC地址**，交换机/网卡不直接识别IP。
> - IP是逻辑地址（可变化），MAC是物理地址（设备唯一标识）。
>
> ### **Q2: ARP欺骗（ARP Spoofing）是什么？**
> - 攻击者伪造ARP响应，劫持流量（如中间人攻击）。防御方法：
>   - 静态ARP绑定、启用DHCP Snooping、使用加密通信（如HTTPS）。
>
> ### **Q3: 无线网络（Wi-Fi）的MAC封装是否不同？**
> - 机制相同，但Wi-Fi帧结构更复杂（包含BSSID等字段），底层仍依赖MAC寻址。
>
> ---
>
> ## **6. 总结**
> - **MAC地址封装由ARP（IPv4）或NDP（IPv6）动态解析**。
> - **同一子网** → **直接查询目标MAC**；**不同子网** → **使用网关MAC**。
> - **关键命令**：`arp -a`（IPv4）、`ip neigh`（IPv6）。



路由问题（网络层交换）

- 事实：A 到 B 有多条路径！
- 路由：**路由器/主机根据 IP 数据包检查其路由表，并将其发送到一个连接的链路上。**

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031707315.webp)

- IP 数据包：`{202.38.103.33|222.201.134.164|81|80|message|CRC}`

- 路由器**根据其路由表检查目标 IP 地址 `{222.201.134.164}`**。

- **路由表由路由算法自动配置。**

- 考虑到路由表的大小，如果 IP 地址无序分配给主机会怎样？采用分层寻址和路由聚合（IP 子网）

  Hierarchical addressing and route aggregation (IP Subnets)

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031711256.webp)

IP 子网和地址/路由聚合

- 层级 IP 地址导致更高效的路由
- **IP 地址不是扁平的：**
  - `{网络地址}+{主机地址}`
  - 159.121.58.0/24, 222.201.0.0/16
- 所有具有相同网络地址的主机属于一个子网。网络 = 子网 + 子网 + …
- 路由：**将一个 IP 数据包从一个子网移动到另一个子网，直到其最终目的地**。

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031818063.webp)



分层架构

网络协议：网络协议指定了**设备识别和相互连接的机制**，以及**规定数据如何打包成发送和接收消息的格式规则**。上层使用下层提供的服务！

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031819030.webp)



互联网 + 以太网

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031822022.webp)

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031828241.webp)



TCP/IP 头

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031830640.webp)



以太网头部

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031831877.webp)





TCP/IP + Ethernet

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506031832243.webp)