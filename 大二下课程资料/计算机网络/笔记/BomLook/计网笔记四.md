# 计网笔记四

分层路由

- 规模：数亿个路由器
- Administrative autonomy: AS

> **“Administrative autonomy: AS”** 中的 **AS** 指的是 **Autonomous System（自治系统）**，这句话的意思是：  
>
> ### **1. Autonomous System (AS) 的定义**
> - **自治系统（AS）** 是互联网中由一个 **独立管理实体（如 ISP、大型企业、大学等）** 控制的一组 **IP 网络和路由器**，它们使用 **相同的路由策略**。  
> - 每个 AS 都有一个全球唯一的 **AS 编号（ASN, Autonomous System Number）**，例如：  
>   - Google 的 ASN: `AS15169`  
>   - 中国电信的 ASN: `AS4134`  
>
> ### **2. Administrative Autonomy（管理自治）**
> - **自治系统（AS）的关键特性就是管理自治**，即：  
>   - **独立的路由策略**：AS 内部可以**自行决定如何路由流量**（如使用 OSPF、EIGRP 等内部网关协议 IGP）。  
>   - **边界路由控制**：AS 之间通过 **BGP（Border Gateway Protocol）** 交换路由信息，但每个 AS 可以自行决定接受或拒绝哪些外部路由。  
>   - **不受外部强制干预**：**只要遵守互联网的通用规则（如 BGP 协议），AS 可以自主管理自己的网络架构**、**IP 地址分配和流量策略**。  
>
> ### **3. 为什么需要 AS？**
> - **互联网的可扩展性**：全球互联网由数万个 AS 组成，BGP 让它们能动态交换路由信息，而不需要集中管理。  
> - **策略控制**：不同 AS 可能有不同的商业或技术需求（如电信运营商、云服务商、企业网络），AS 允许它们独立运作。  
> - **故障隔离**：一个 AS 内部的问题（如路由震荡）不会直接影响其他 AS。  
>
> ### **4. 示例**
> - **ISP（互联网服务提供商）** 如中国电信（AS4134）是一个 AS，它自主管理自己的网络，并与其他 AS（如中国联通 AS4837）通过 BGP 交换路由。  
> - **大型企业/云厂商** 如 Google（AS15169）也是一个 AS，它控制自己的全球数据中心网络，并决定如何与外部网络互联。  
>
> ### **总结**
> “**Administrative autonomy: AS**” 强调 **自治系统（AS）是互联网中具有独立管理权的网络单元**，它们**通过 BGP 互联，但各自保持路由策略和管理自主性**。这是互联网去中心化架构的核心设计之一。



互联网中的 AS 内部路由

- 一个自治系统（AS）内部的路由协议**用于确定在自治系统内部如何进行路由。**
- 在互联网（广泛使用）的路由协议如下：
  - 路由信息协议（RIP）：基于距离向量
  - 开放最短路径优先 (OSPF)：基于链路状态



路由信息协议（RIP）

- 成本度量：**每条链路成本为 1**。
- 路径成本：
  - 从源路由器到目标子网；
  - 跳数，**即从源路由器到目标子网沿最短路径经过的子网数量，包括目标子网。**
- 路径的最大成本限制为 15，因此限制了 RIP 的使用范围，仅适用于跳数直径小于 15 自治系统。

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506032011104.webp)

- RIP 广告/RIP 响应消息：相邻路由器相互交换距离向量，大约每 30 秒， the sender’s distance to each of a list up to 25 destination subnets（需要研究一下算法原理）

> ### **RIP（Routing Information Protocol）算法详解**
> RIP 是一种基于**距离向量（Distance Vector）**的**内部网关协议（IGP）**，用于在**自治系统（AS）内部**进行路由选择。它是早期广泛使用的动态路由协议，**适用于小型网络。**
>
> ---
>
> ## **1. RIP 的基本原理**
> RIP 的核心思想是：
> - **每个路由器**维护一张**路由表**，记录到达目标网络的**距离（跳数）**和**下一跳路由器**。
> - **周期性（默认30秒）**向邻居路由器发送自己的路由表。
> - 采用**Bellman-Ford 算法**计算最短路径，选择**跳数最少**的路由。
>
> ---
>
> ## **2. RIP 的关键特性**
> | 特性         | 说明                                                         |
> | ------------ | ------------------------------------------------------------ |
> | **算法类型** | 距离向量（Distance Vector）                                  |
> | **度量标准** | **跳数（Hop Count）**，最大有效跳数为 **15**（16 表示不可达） |
> | **更新方式** | **周期性广播/组播（默认30秒）** + **触发更新**（网络变化时立即通知） |
> | **端口号**   | **UDP 520**                                                  |
> | **版本**     | RIPv1（无类，广播）、RIPv2（支持CIDR，组播）、RIPng（IPv6）  |
> | **收敛速度** | 较慢（存在“慢收敛”问题）                                     |
>
> ---
>
> ## **3. RIP 的工作流程**
> ### **（1）初始化**
> - 路由器启动时，仅知道**直连网络**（跳数=0）。
> - 向邻居发送**请求报文**，获取初始路由信息。
>
> ### **（2）路由更新**
> - **周期性广播/组播**（默认30秒）：
>   - 每个路由器向邻居发送**完整路由表**。
> - **触发更新**（网络变化时）：
>   - 立即通知邻居，避免长时间等待。
>
> ### **（3）路由计算（Bellman-Ford 算法）**
> 1. 收到邻居的路由表后，检查每条路由：
>    - 如果目标网络**不在本地路由表**中，**直接添加**。
>    - 如果**已存在**，但**新路径跳数更少，则更新**。
>    - 如果**下一跳相同**，无论**跳数是否变化，都更新**（防止路由震荡）。
> 2. **跳数+1**（因为数据包需要经过当前路由器转发）。
>
> ### **（4）路由失效**
> - 如果 **180秒**（默认）未收到某条路由的更新，标记为**不可达（跳数=16）**。
> - 再等待 **120秒**（垃圾回收时间），彻底删除该路由。
>
> ---
>
> ## **4. RIP 的优缺点**
> ### **✅ 优点**
> - **简单易配置**，适合小型网络。
> - **无需复杂计算**，资源消耗低。
> - **兼容性好**，几乎所有路由器都支持。
>
> ### **❌ 缺点**
> - **最大跳数限制（15）**，不适合大型网络。
> - **收敛速度慢**，可能导致临时环路。
> - **仅以跳数为度量**，不考虑带宽、延迟等。
> - **广播更新（RIPv1）**，浪费带宽。
>
> ---
>
> ## **5. RIP 的改进版本**
> | 版本                  | 改进点                                                  |
> | --------------------- | ------------------------------------------------------- |
> | **RIPv2**             | 支持 **VLSM/CIDR**、**组播更新（224.0.0.9）**、**认证** |
> | **RIPng**             | 支持 **IPv6**                                           |
> | **EIGRP**（思科私有） | 改进 RIP 的收敛问题，采用 **DUAL 算法**                 |
>
> ---
>
> ## **6. 示例：RIP 路由表**
> 假设网络拓扑：
> ```
> R1 ---(跳数=1)--- R2 ---(跳数=1)--- R3
> ```
> - **R1 的路由表**：
>   | 目标网络 | 下一跳 | 跳数 |
>   | -------- | ------ | ---- |
>   | NetA     | 直连   | 0    |
>   | NetB     | R2     | 1    |
>   | NetC     | R2     | 2    |
>
> - **R2 的路由表**：
>   | 目标网络 | 下一跳 | 跳数 |
>   | -------- | ------ | ---- |
>   | NetA     | R1     | 1    |
>   | NetB     | 直连   | 0    |
>   | NetC     | R3     | 1    |
>
> ---
>
> ## **7. 总结**
> - RIP 是一种**简单的距离向量路由协议，适用于小型网络**。
> - 采用**跳数**作为度量，最大有效跳数为 **15**。
> - 通过**周期性广播+触发更新**维护路由表。
> - 主要问题：**收敛慢、跳数限制、仅支持小型网络**。
> - 改进版本：RIPv2（支持CIDR）、RIPng（IPv6）。
>
> 如果需要更高效的路由协议，可以考虑 **OSPF（链路状态）** 或 **EIGRP（高级距离向量）**。



开放最短路径优先 (OSPF)

- 单个链路成本由网络管理员配置
  - 将所有链路成本设置为 1，或者将链路权重设置为与链路容量成反比，以阻止流量使用低带宽链路。
  - 通过链路状态信息的泛洪，路由器构建整个自治系统的完整拓扑图（即，一个图）。链路状态变化，或每 30 分钟。
  - 路由器随后在本地运行 Dijkstra 最短路径算法，以自身为根节点，确定到所有子网的最短路径树。





自治系统间路由：BGP

- 边界网关协议版本 4 是事实上的标准，当今互联网中的 AS 间路由协议。它通常被称为 BGP4，或简称为 BGP。
  - 从**相邻的 AS（自治系统）获取子网可达性**信息。
  - 将可达性信息传播到 **AS 内部的所有路由器**。
  - 根据**可达性信息以及 AS 策略，确定到子网的“好”路由**。
- BGP 极其复杂，这里不作详述。（后续研究）



AS-PATH、下一跳、路由策略



 RIP 是基于距离向量（DV）路由算法

- 分布式
- 每个节点从**其一个或多个直接连接的邻居那里接收一些信息，执行计算，然后将计算结果分发回其邻居**。
- 迭代：这个过程**一直持续到邻居之间不再交换更多信息**
- 异步：**它不需要所有节点都与其他节点同步运行。**



Bellman-Ford 方程

- $d_{x}(y)$ 表示从节点 x 到节点 y 的最短路径的成本。
  $$
  d_x{(y)}=\min_{v}\{c(x,v)+d_v(y)\}
  $$
  在方程中，$\min_v$ 的取值范围是 x 的所有邻居。

  ![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506032103570.webp)



DV 算法

- 每个节点 x 最初具有 $D_{x}(y)$，这是从 x 到节点 y 的最小成本路径的成本估计，对于 N 中的所有节点。
- $D_{x}=[D_x(y): y \text{ in } N]$ 是节点 x 的距离向量，这是从 x 到 N 中的所有其他节点 y 的成本估计的向量。
- 使用 DV 算法，每个节点 x 维护以下路由信息：

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506032107292.webp)

- 由节点 x 运行的 DV 算法：

  ![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506032108440.webp)

- DV 算法是**去中心化的，不使用这类全局信息**。实际上，节点拥有的信息仅限于与**其直接连接的邻居的链路成本以及从这些邻居接收到的信息**。

  ![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506032109904.webp)

- 在节点 x 处，接收更新后：

  ![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506032110812.webp)



分层路由

- 我们学习的 LS 和 DV 算法不仅在实践中广泛使用，它们本质上也是当今互联网上实际使用的唯一路由算法。

- 自治系统（AS）：**自治系统内部路由协议。**

  - 每个自治系统由**一组通常在相同管理控制下的路由器组成**
  - 同一 AS 内的路由器**都运行相同的路由算法，并且彼此拥有信息**
  - **通过网关路由器连接到其他 AS**

- AS 内的路由器**确定 AS 内部源-目的对之间的路由路径。**

- 一个路由器，在某个 AS 内，如何知道如何将数据包路由到 AS 外部的目的地？

  ![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506032113540.webp)





自治系统间路由协议

- **从相邻的自治系统获取可达性信息**，并**将可达性信息传播到自治系统内部的所有路由器。**
- 由于自治系统间路由协议**涉及两个自治系统之间的通信，因此两个通信的自治系统必须运行相同的自治系统间路由协议**。
- 事实上，在互联网上所有 AS 都运行相同的外部网关协议，称为 BGP4。

![](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202506032115995.webp)

