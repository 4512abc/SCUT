# 第10章：存储与文件结构

==分析思路：由外及内，由粗及细，由具体及抽象，从最外层的磁盘，到文件组织形式，到文件中的记录的组织形式，再到数据的组织形式==

## 存储层次结构
缓存（cache）→ 主存（main memory）→ 闪存（flash memory）→ 磁盘（magnetic disk）→ 光盘（optical disk）→ 磁带（magnetic tapes）

## 磁盘（Magnetic Disks）
### 物理结构
- 盘片（platter）表面被划分为圆形磁道（track），典型硬盘每盘片含50,000-100,000条磁道。
- 每条磁道又划分为扇区（sector），**扇区是最小的读写单位，通常大小为512字节**；每条磁道的扇区数因位置而异，内圈磁道通常为500-1000个，外圈磁道为1000-2000个。
- 柱面（cylinder）：所有盘片上半径相同的磁道组成一个柱面（如第i个柱面包含所有盘片的第i条磁道）。

### 读写原理

要读写某个扇区，需执行以下步骤：
1. 磁头臂（disk arm）移动，将磁头（head）定位到目标磁道。
2. 盘片持续（spin）旋转，当目标扇区转到磁头下方时，进行数据读写。

![image-20251223102819176](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/image-20251223102819176.png)



### 性能指标
1. 访问时间（Access Time）：从**发出读写请求到数据传输开始**的时间，等于**寻道时间与旋转延迟之和**。
   - 寻道时间（Seek Time）：**磁头臂移动到目标磁道**的时间。
     - 平均寻道时间约为最坏情况的1/2（若忽略磁头启动和停止时间，且**所有磁道扇区数相同**，约为1/3），典型硬盘的平均寻道时间为4-10毫秒。
   - 旋转延迟（Rotational Latency）：**目标扇区旋转到磁头下方**的时间。
     - 平均旋转延迟为最坏情况的1/2，典型硬盘（转速5400-15000转/分钟）的平均旋转延迟为4-11毫秒。
2. 数据传输率（Data-Transfer Rate）：数据**从磁盘读取或写入磁盘的速率**。
   - 最大传输率为25-100 MB/秒（**内圈磁道传输率更低**）。
   - 多层的磁盘可能会共享**控制器**，因此控制器传输能力同样关键，例如：SATA（150 MB/秒）、SATA-II（300 MB/秒）、Ultra 320 SCSI（320 MB/秒）、SAS（3-6 Gb/秒）、光纤通道（FC 2Gb/4Gb：256-512 MB/秒）。



### 磁盘块访问优化

1. 块（Block）：单个磁道上**连续的扇区序列**，是**内存与磁盘之间数据传输的最小单位**，1个块包含**多个连续扇区**，大小通常为**512Byte到数KB**（当前典型块大小为4-16 KB）。
   - 小块：磁盘传输次数增多。
   - 大块：部分填充的块会造成空间浪费。
2. 文件组织（File Organization）：通过**合理组织块的存储位置**，**优化块访问时间**（如将**相关数据存储在同一或相邻柱面**）。
3. 文件碎片（Fragmentation）：
   - 成因：文件插入/删除操作、磁盘空闲块分散导致新建文件的块**分散存储**。
   - 影响：顺序访问碎片文件会**增加磁头臂移动次数，降低效率**。
   - 解决方案：使用**文件系统碎片整理工具，重组文件块以加速访问**。



### 核心小结
| 维度 | 关键信息 |
| ---- | ---- |
| 块与扇区 | 1个块 = 多个连续扇区；1个文件（哈希文件除外）= 多个连续块 |
| 磁头与磁盘 | 磁头读写数据的最小单位是扇区 |
| 内存与磁盘 | 内存与磁盘交换信息的最小单位是块 |
| 访问开销 | 开销 = 寻道时间 + 旋转时间 + 传输时间；**数据库核心关注：寻道次数、传输磁盘块个数** |
| 块访问规则 | ==若连续访问的块B1和B2相邻，寻道次数为1；无论是否相邻，传输块个数均为2（非常重要的一点）== |



## 缓冲管理器（Buffer Manager）

### 核心功能
程序需要磁盘块时，向缓冲管理器发起请求，缓冲管理器的处理逻辑如下：
1. 若块已在缓冲区（buffer）中，直接返回**该块在主存中的地址**。
2. 若块不在缓冲区：
   - 为该块**分配缓冲区空间（若缓冲区已满，需替换部分块）**。
   - 替换规则：仅当**被替换块**自上次写入后**被修改过**，才将其写回磁盘。
   - 从磁盘读取块到缓冲区，返回该块在主存中的地址。

### 缓冲区替换策略（Buffer-Replacement Policies）
1. 最近最少使用（LRU）策略：
   - 原理：以过去的块访问模式预测未来访问，**替换最久未使用的块**。
   - 局限性：对于**重复扫描数据的访问模式**（如嵌套循环连接两关系r和s），LRU策略效果较差。
   - 嵌套循环连接示例：
     ```
     for each tuple tr of r do 
         for each tuple ts of s do 
             if the tuples tr and ts match …
     ```

2. 立即丢弃（Toss-immediate）策略：处理完**块的最后一个元组后**，**立即释放**该块占用的缓冲区空间，适用于**上述嵌套循环场景**。

3. 最近最多使用（MRU）策略：

   - **锁定块（Pinned Block）**：不允许写回磁盘的内存块（如当前正在处理的块）。

   - 原理：**锁定**当前正在处理的块，处理完**最后一个元组后**解锁，并将其**标记为“最近使用”**，替换**最久未使用**的块。

4. 启发式优化：
   - 利用**统计信息预测访问概率**（如数据字典频繁被访问，优先保留在缓冲区）。
   - 支持强制写回块（用于故障恢复，详见第16章）。





## 文件组织（File Organization）

数据库以文件集合形式存储，**每个文件是记录的序列，每条记录是字段的序列**。先假设

1. **记录长度固定**
2. 同一文件仅存储**一种类型**的记录
3. 不同文件被用于不同关系

后续讨论变长记录。

### 固定长度记录（Fixed-Length Records）
1. 基础存储方式：第i条记录从字节`n × (i - 1)`开始存储（n为每条记录的大小）。

   - 优点：记录访问简单。

   - 缺点：记录可能跨块存储。
   - **优化**存储方式：**不允许记录跨块**，确保每条记录完整存储在一个块中。

2. 记录删除处理：
   - 方案1：将第 $i+1$至第 $n$ 条记录依次前移，填补第 $i$ 条记录的空位。（后续部分全面前移）
   - 方案2：将最后一条记录（第 $n$ 条）移至第 $i$ 条记录的位置。（最后一条前移）
   - 方案3：不移动记录，通过**空闲列表（free list）链接所有被删除**的记录。（使用链表记录所有被删除的记录）

### 空闲列表（Free Lists）
1. 原理：文件头部存储第一个被删除记录的地址，该记录中存储第二个被删除记录的地址，依次形成链表（存储的地址可视为“指针”）。
2. 优势：删除和插入记录时**无需移动其他记录，效率更高**。

![image-20251223105256505](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/image-20251223105256505.png)



### 变长记录（Variable-Length Records）
#### 产生场景
- 一个文件**存储多种类型**的记录。
- 记录中包含**变长字段**。

#### 槽式页面结构（Slotted Page Structure）
1. 块头部（Block Header）包含：
   - 记录条目数（number of record entries）。
   - 块中**空闲空间的末尾位置（end of free space）**（因为records是存储在后面的）。
   - 每条记录的**位置和大小（location and size of each record）**。
2. 存储优化：块内记录**可移动**，**保持连续无间隙**，只需**更新块头部的记录条目**（指针不直接指向记录，而是**指向块头部的记录条目**）。

![image-20251223105642290](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/image-20251223105642290.png)



## 文件中记录的组织方式（Organization of Records in Files）

### 堆文件（Heap）
记录可存储在文件中任何空闲位置，**无固定顺序。**



### 顺序文件（Sequential File）

1. 特点：记录按**搜索键（search key）的值**顺序存储，适用于**全文件顺序处理场景**。
2. 记录删除：通过**指针链标记**被删除的记录位置。
3. 记录插入：
   - 若目标位置有空闲空间，直接插入。
   - 若目标位置**无空闲空间，插入到溢出块（overflow block）**。
   - 无论哪种情况，均需**更新指针链**。
4. 维护：需**定期重组文件，恢复顺序存储**（避免指针链过长导致访问效率下降）。

![image-20251223110234510](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/image-20251223110234510.png)



### 哈希文件（Hashing）

通过哈希函数计算**记录某属性的值**，确定记录**应存储的块位置**（详见后续章节）。



### 多表聚簇文件组织（Multitable Clustering File Organization）

1. 原理：将**多个关系的记录存储**在同一个文件中，使相关记录（如客户和其账户记录）**存储在同一块，减少I/O操作**。
2. 适用场景：
   - 优点：适合**关联查询**（如查询客户及其账户信息）。
   - 缺点：不适合**仅访问单个关系**的查询（如仅查询客户信息）。
3. 特点：
   - 记录长度可变。
   - 可通过指针链链接同一关系的记录。

![image-20251223110603572](https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/image-20251223110603572.png)



## 数据字典存储（Data-Dictionary Storage）

数据字典（又称系统目录）存储元数据（metadata），即“关于数据的数据”。

### 存储内容
1. 关系相关信息：
   - 关系名称
   - 属性名称及类型。
   - 视图名称及定义。
   - 完整性约束。
2. 用户与计费信息（如用户名、加密密码）。
3. 统计描述数据（如每个关系的元组数量）。
4. 物理文件组织信息：
   - 关系的**存储方式**（顺序/哈希/堆）。
   - 关系的**物理存储位置**。
5. 索引相关信息（详见第11章）。

### 目录表示示例

```sql
Relation_metadata = (relation_name, number_of_attributes, storage_organization, location)
Attribute_metadata = (attribute_name, relation_name, domain_type, position, length)
User_metadata = (user_name, encrypted_password, group)
Index_metadata = (index_name, relation_name, index_type, index_attributes)
View_metadata = (view_name, definition) 
```

